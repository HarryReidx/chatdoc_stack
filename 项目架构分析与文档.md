# ChatDoc Stack 项目架构分析与文档

## 项目概述

ChatDoc Stack 是一个基于 RAG（检索增强生成）技术的知识库问答系统，主要依赖 TextIn 商业 API 进行文档解析和处理。项目采用微服务架构，包含前端、后端、文档处理服务和代理服务四个主要组件。

## 整体架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Frontend      │    │   Backend       │    │   ChatDoc       │
│   (Vue/Nuxt)    │◄──►│   (NestJS)      │◄──►│   (Python)      │
│   Port: 3001    │    │   Port: 3000    │    │   Port: 5000    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │                       │
                                │                       ▼
                                │              ┌─────────────────┐
                                │              │ ChatDoc-Proxy   │
                                │              │ (FastAPI)       │
                                │              │ Port: 8000      │
                                │              └─────────────────┘
                                │                       │
                                ▼                       ▼
                       ┌─────────────────┐    ┌─────────────────┐
                       │   MySQL         │    │ Elasticsearch   │
                       │   (数据存储)     │    │ (向量数据库)     │
                       └─────────────────┘    └─────────────────┘
```

## 组件详细分析

### 1. Frontend (前端服务)

**技术栈：**
- Vue 3 + Nuxt 3
- TypeScript
- Ant Design Vue
- Tailwind CSS
- Pinia (状态管理)

**主要功能：**
- 用户界面和交互
- 文档上传和预览
- 问答界面和流式响应显示
- 文档目录展示和导航
- 答案来源溯源和高亮显示

**核心文件结构：**
- `app.vue` - 应用主入口
- `nuxt.config.ts` - Nuxt 配置
- `components/` - 可复用组件
- `pages/` - 页面路由
- `store/` - Pinia 状态管理

### 2. Backend (后端服务)

**技术栈：**
- Node.js + NestJS
- TypeScript
- TypeORM
- MySQL
- Redis (缓存)
- JWT (认证)

**主要功能：**
- 用户认证和授权
- 知识库文档管理
- 问答记录存储
- API 接口提供
- 文件上传下载管理

**核心模块：**
- `UserModule` - 用户管理
- `DocumentModule` - 文档管理
- `ChatModule` - 对话管理
- `LibraryModule` - 知识库管理

### 3. ChatDoc (文档处理服务)

**技术栈：**
- Python 3.9+
- Flask
- Pydantic
- 多种 LLM 集成 (OpenAI, DeepSeek, 通义千问等)

**主要功能：**
- 文档解析和处理
- 文本切片和向量化
- 知识检索和问答
- 多种问答模式支持

**核心模块：**
- `pkg/doc/` - 文档解析
- `pkg/personal/` - 个人知识库
- `pkg/analyst/` - 分析问答
- `pkg/global_/` - 全局问答
- `pkg/embedding/` - 向量化处理
- `pkg/rerank/` - 重排序

### 4. ChatDoc-Proxy (代理服务)

**技术栈：**
- Python + FastAPI
- 异步处理

**主要功能：**
- 向量化批处理
- ES 搜索代理
- 图片备份和下载
- 性能优化和缓存

## TextIn 商业 API 使用分析

### 1. PDF 解析 API

**API 端点：** `https://api.textin.com/ai/service/v1/pdf_to_markdown`

**功能：** 将 PDF 文档转换为 Markdown 格式，支持表格、图片、文档结构等

**使用位置：**
- `code/chatdoc/pkg/clients/textin_ocr.py`
- `code/chatdoc/pkg/doc/pdf2md.py`
- `code/chatdoc/pkg/personal_doc/pdf2md.py`

**配置参数：**
```python
options = {
    'dpi': 144,
    'page_start': 0,
    'page_count': 2000,
    'apply_document_tree': 1,
    'markdown_details': 1,
    'page_details': 1,
    'table_flavor': 'html',
    'get_image': 'page',
    'parse_mode': 'scan'
}
```

### 2. 向量化 API

**API 端点：** `https://api.textin.com/ai/service/v1/acge_embedding`

**功能：** 文本向量化，支持批量处理和维度配置

**使用位置：**
- `code/chatdoc/pkg/embedding/acge_embedding.py`
- `code/chatdoc-proxy/app/services/embedding.py`

**请求格式：**
```python
{
    "input": ["文本1", "文本2"],
    "matryoshka_dim": 1024,
    "digit": 8
}
```

### 3. 重排序 API

**API 端点：** `https://api.textin.com/ai/service/v1/rerank`

**功能：** 文本相关性重排序，提高检索精度

**使用位置：**
- `code/chatdoc/pkg/rerank/__init__.py`
- `code/chatdoc/pkg/analyst/rerank_by_answer.py`
- `code/chatdoc/pkg/personal/rerank_by_answer.py`

### 4. 图片下载 API

**API 端点：** `https://api.textin.com/ocr_image/download`

**功能：** 下载解析过程中提取的图片

**使用位置：**
- `code/chatdoc-proxy/app/services/backup_images.py`
- `code/backend/src/common/utils/image.ts`

## 数据流分析

### 文档处理流程

1. **文档上传** → Frontend → Backend → ChatDoc
2. **文档解析** → ChatDoc → TextIn PDF2MD API
3. **文本切片** → ChatDoc 内部处理
4. **向量化** → ChatDoc → TextIn Embedding API
5. **存储** → ChatDoc-Proxy → Elasticsearch

### 问答流程

1. **用户提问** → Frontend → Backend → ChatDoc
2. **向量检索** → ChatDoc → Elasticsearch
3. **重排序** → ChatDoc → TextIn Rerank API
4. **LLM 生成** → ChatDoc → 配置的 LLM 服务
5. **结果返回** → ChatDoc → Backend → Frontend

## Megaparse 替换方案评估

### Megaparse 能力分析

**支持格式：**
- ✅ PDF
- ✅ PowerPoint
- ✅ Word
- ✅ 图片格式

**功能特性：**
- ✅ 表格解析
- ✅ 目录提取
- ✅ 页眉页脚
- ✅ 图片提取
- ✅ 文档结构识别

**技术架构：**
- 基于 Python 3.11+
- 支持多种解析策略 (AUTO, HI_RES, FAST)
- 集成 DocTR OCR 引擎
- 支持 Unstructured 解析器
- 可配置 LLM 后处理

### 替换可行性分析

#### 优势：
1. **开源免费** - 无 API 调用费用
2. **本地部署** - 数据安全性更高
3. **可定制** - 可根据需求调整解析策略
4. **多格式支持** - 覆盖 TextIn 的主要功能

#### 挑战：
1. **解析精度** - 需要验证与 TextIn 的精度差异
2. **性能优化** - 本地部署需要考虑硬件资源
3. **维护成本** - 需要自行维护和更新
4. **集成工作** - 需要修改现有代码架构

### 迁移实施方案

#### 阶段一：环境准备和测试
1. 部署 Megaparse 服务
2. 准备测试文档集
3. 对比解析结果质量
4. 性能基准测试

#### 阶段二：接口适配
1. 创建 Megaparse 适配器
2. 实现与现有接口兼容的 API
3. 添加配置开关支持双引擎

#### 阶段三：逐步迁移
1. 先迁移非关键业务
2. 监控解析质量和性能
3. 根据反馈调整优化
4. 完全切换到 Megaparse

## 配置和部署

### 环境变量配置

**ChatDoc 服务：**
```yaml
textin:
  app_id: 'your_app_id'
  app_secret: 'your_app_secret'
  embedding_url: 'https://api.textin.com/ai/service/v1/acge_embedding'
  rerank_url: 'https://api.textin.com/ai/service/v1/rerank'

pdf2md:
  url: 'https://api.textin.com/ai/service/v1/pdf_to_markdown'
  download_url: 'https://api.textin.com/ocr_image/download'
```

**Backend 服务：**
```env
TEXTIN_APP_ID=your_app_id
TEXTIN_APP_SECRET=your_app_secret
TEXTIN_DOWNLOAD_URL=https://api.textin.com/ocr_image/download
```

### Docker 部署

项目支持 Docker 容器化部署，每个服务都有对应的 Dockerfile：
- `code/frontend/Dockerfile`
- `code/backend/Dockerfile`
- `code/chatdoc/Dockerfile`
- `code/chatdoc-proxy/Dockerfile`

## 总结和建议

### 当前架构优势：
1. 微服务架构，模块化程度高
2. TextIn API 提供高质量的文档解析
3. 支持多种 LLM 和向量数据库
4. 完整的前后端分离架构

### 改进建议：
1. **API 替换准备** - 逐步引入 Megaparse 作为备选方案
2. **监控完善** - 添加 API 调用监控和成本统计
3. **缓存优化** - 增强解析结果缓存机制
4. **错误处理** - 完善 API 失败时的降级策略

### Megaparse 迁移优先级：
1. **高优先级** - PDF 解析功能（核心功能）
2. **中优先级** - 图片处理功能
3. **低优先级** - 向量化和重排序（可考虑其他开源方案）

通过逐步迁移和充分测试，可以实现从 TextIn 商业 API 到 Megaparse 本地部署的平滑过渡，在保证功能完整性的同时降低运营成本。
